<!DOCTYPE html>
<html lang="ku" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>گەریان</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load html2pdf.js for client-side PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Configure Tailwind to use Inter font and enable dark mode -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Noto Sans Arabic', 'Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'primary-dark': '#6366f1',
                        'bg-dark': '#0f172a',
                        'card-dark': '#1e293b',
                        'text-light': '#f1f5f9',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;700;900&display=swap');

        @keyframes button-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .pulsing-button {
            animation: button-pulse 0.8s ease-in-out infinite alternate;
        }
        
        body {
            line-height: 1.8;
        }

        /* Ensure list styling is correct for Arabic script */
        #result-text ul {
            list-style-type: disc;
            padding-right: 1.5em; 
            margin-right: 1.5em; 
        }

        /* PDF specific styles to ensure Arabic font rendering */
        .pdf-content * {
            font-family: 'Noto Sans Arabic', 'Arial', sans-serif !important;
            color: #000 !important;
            direction: rtl !important;
            text-align: right !important;
        }
        .pdf-content h3 {
            color: #4f46e5 !important; 
            border-bottom: 2px solid #ddd !important;
            padding-bottom: 5px !important;
            margin-bottom: 15px !important;
        }
        .pdf-content {
            background-color: white !important;
            padding: 20px;
            border: none !important;
        }
        .pdf-content a {
            color: #1e40af !important; /* Tailwind blue-700 for links */
            text-decoration: underline !important;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-bg-dark font-sans text-gray-900 dark:text-text-light transition-colors duration-500 min-h-screen p-4 sm:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        
        <!-- Header, Title & Theme Toggle -->
        <header class="text-center mb-10">
            <div class="flex justify-between items-center mb-6">
                <!-- Theme Toggle Button -->
                <button onclick="toggleTheme()" id="theme-toggle" class="p-3 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-200 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors shadow-lg"
                        title="گوهۆرینا مۆدێ">
                    <svg id="sun-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <div class="flex-grow"></div>
            </div>

            <h1 class="text-5xl font-extrabold text-primary-dark tracking-tight leading-tight">
                گەریان
            </h1>
            <p class="text-xl font-medium text-gray-500 dark:text-gray-400 mt-3">زانیاریێن تازە و پشتڕاستکری ل دەستێ تە.</p>
        </header>

        <!-- Search Input Form -->
        <div class="mb-12 bg-white dark:bg-card-dark p-8 rounded-2xl shadow-2xl border border-gray-200 dark:border-gray-700 transition-shadow duration-300 hover:shadow-primary/30">
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 sm:space-x-reverse">
                <input type="text" id="search-input" placeholder="پرسیارا خۆ بنڤیسە بۆ دەستپێکرنا گەڕینێ..." 
                       class="flex-grow p-4 text-xl border border-gray-300 dark:border-gray-600 rounded-xl focus:ring-4 focus:ring-primary focus:border-primary dark:bg-gray-700 dark:text-text-light transition-all shadow-md text-right"
                       onkeydown="if(event.key === 'Enter') performSearch()">
                
                <button onclick="performSearch()" id="search-button"
                        class="px-8 py-4 text-xl font-bold text-white bg-primary rounded-xl shadow-lg hover:bg-primary-dark transition-transform transform hover:scale-[1.03] active:scale-[0.98] focus:outline-none focus:ring-4 focus:ring-primary/50 disabled:opacity-50 flex items-center justify-center space-x-2 space-x-reverse">
                    <svg id="search-icon" class="w-6 h-6 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <span id="button-text">گەریان</span>
                </button>
            </div>
        </div>

        <!-- Results Area -->
        <div id="results-container">
            <div id="initial-message" class="text-center p-10 text-gray-500 dark:text-gray-400 rounded-2xl border border-dashed border-gray-300 dark:border-gray-700">
                <svg class="w-12 h-12 mx-auto mb-4 text-primary-dark/50" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path></svg>
                <p class="text-lg font-medium">پرسیارەکێ بنڤیسە بۆ دەستپێکرنا سەیرکرنا ئەنجامێن نوو.</p>
            </div>

            <!-- Placeholder for Loading State -->
            <div id="loading-indicator" class="hidden text-center p-12">
                <div class="text-2xl text-primary-dark font-extrabold pulsing-button">چاڤەرێ بە.....</div>
            </div>
            
            <!-- Result Card -->
            <div id="search-result-card" class="hidden bg-white dark:bg-card-dark p-8 rounded-2xl shadow-xl border border-gray-200 dark:border-gray-700 transition-all duration-500">
                
                <!-- PDF Download and Title Header -->
                <div class="flex justify-between items-center mb-4 border-b pb-3 border-gray-200 dark:border-gray-700">
                    <h2 class="text-3xl font-bold text-primary-dark">ئەنجامێن گەڕینێ</h2>
                    
                    <button onclick="downloadPdf()" id="download-button"
                            class="px-5 py-2 text-md font-bold text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 transition-colors disabled:opacity-50 flex items-center space-x-2 space-x-reverse"
                            title="داگرتنا ئەنجامان وەکو PDF">
                        <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        <span id="download-button-text">داگرتنا PDF</span>
                    </button>
                </div>
                
                <!-- Content Area for PDF Generation -->
                <div id="pdf-content-area" class="pdf-content p-2">
                    <h3 id="pdf-query-title" class="text-xl font-bold text-gray-700 dark:text-gray-300 mb-4 hidden border-b pb-2 border-dashed"></h3>

                    <div id="result-text" class="prose dark:prose-invert max-w-none text-base leading-relaxed text-right">
                        <!-- Generated text goes here -->
                    </div>
                    
                    <!-- Sources Section -->
                    <div id="sources-section" class="pt-6 border-t border-gray-200 dark:border-gray-700 mt-6">
                        <p class="font-bold text-base text-gray-600 dark:text-gray-400 mb-3">ژێدەرێن پشتڕاستکری:</p>
                        <div id="sources-list" class="space-y-3 text-base text-right">
                            <!-- Sources list goes here -->
                        </div>
                    </div>
                </div>

            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-100 dark:bg-red-900/50 text-red-700 dark:text-red-300 p-6 rounded-xl border border-red-300 dark:border-red-700 shadow-lg text-right">
                <p class="font-bold text-xl mb-1">هەڵەک ڕوودا!</p>
                <p id="error-text" class="text-lg"></p>
            </div>
        </div>

        <!-- Footer Branding -->
        <footer class="mt-16 text-center text-md text-gray-500 dark:text-gray-500">
            <p>دیزاین و پرۆگرامکرن ژ لایێ: <span class="font-extrabold text-primary-dark dark:text-primary-dark/80">es group</span></p>
        </footer>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // Calls the secure serverless function endpoint (Now /generate-content instead of /api/generate-content)
        const API_ENDPOINT = '/generate-content';
        const MAX_RETRIES = 5;
        
        // UI Elements
        const html = document.documentElement;
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const buttonText = document.getElementById('button-text');
        const searchIcon = document.getElementById('search-icon');
        const loadingIndicator = document.getElementById('loading-indicator');
        const initialMessage = document.getElementById('initial-message');
        const searchResultCard = document.getElementById('search-result-card');
        const resultText = document.getElementById('result-text');
        const sourcesList = document.getElementById('sources-list');
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const downloadButton = document.getElementById('download-button');
        const downloadButtonText = document.getElementById('download-button-text');
        const pdfContentArea = document.getElementById('pdf-content-area');
        const pdfQueryTitle = document.getElementById('pdf-query-title');


        // --- Theme Management ---
        function setInitialTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark' || (!storedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                html.classList.add('dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggle.setAttribute('aria-label', 'مۆدا ڕۆناهی');
            } else {
                html.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
                themeToggle.setAttribute('aria-label', 'مۆدا تاری');
            }
        }

        function toggleTheme() {
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('theme', 'light');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
                themeToggle.setAttribute('aria-label', 'مۆدا تاری');
            } else {
                html.classList.add('dark');
                localStorage.setItem('theme', 'dark');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                themeToggle.setAttribute('aria-label', 'مۆدا ڕۆناهی');
            }
        }

        window.onload = setInitialTheme;

        // --- API Utilities ---
        function sleep(attempt) {
            const delay = Math.pow(2, attempt) * 1000;
            return new Promise(resolve => setTimeout(resolve, delay));
        }

        async function fetchTextContent(prompt) {
            for (let attempt = 0; attempt < MAX_RETRIES; attempt++) {
                try {
                    // Call the secure backend endpoint
                    const response = await fetch(API_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt: prompt })
                    });

                    if (response.status === 429 && attempt < MAX_RETRIES - 1) {
                        console.warn(`(429) Rate limit exceeded. Retrying text generation...`);
                        await sleep(attempt);
                        continue;
                    }

                    if (!response.ok) {
                        const errorData = await response.json();
                        const apiError = errorData.error || 'هەڵەک نەدیار ل لایێ سێرڤەری.';
                        throw new Error(`شکەستن ل گەڕینا دەستنڤیسێ: ${response.status}. دیتات: ${apiError}`);
                    }

                    return await response.json();

                } catch (error) {
                    if (attempt === MAX_RETRIES - 1) throw error;
                    await sleep(attempt);
                }
            }
        }

        // --- PDF Generation Logic ---
        function downloadPdf() {
            downloadButton.disabled = true;
            downloadButtonText.textContent = 'داگرتن...';
            
            const element = pdfContentArea;

            const options = {
                margin: 15,
                filename: 'ئەنجامێن گەڕینێ_' + new Date().toISOString().slice(0, 10).replace(/-/g, '') + '.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2, 
                    logging: false,
                    letterRendering: true,
                    allowTaint: true,
                    useCORS: true
                },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
            
            element.classList.add('print-styles');
            
            html2pdf().from(element).set(options).save().then(() => {
                element.classList.remove('print-styles');
                downloadButton.disabled = false;
                downloadButtonText.textContent = 'داگرتنا PDF';
            }).catch(error => {
                console.error("PDF Download Error:", error);
                
                errorText.textContent = "هەڵە د دروستکرنا PDF دا ڕوودا. دڵنیابە لەوەی فۆنتە عەرەبییەکان بە دروستی دەردەچن.";
                errorMessage.classList.remove('hidden');
                
                element.classList.remove('print-styles');
                downloadButton.disabled = false;
                downloadButtonText.textContent = 'داگرتنا PDF';
            });
        }


        /**
         * Handles the main search interaction.
         */
        async function performSearch() {
            const query = searchInput.value.trim();

            searchResultCard.classList.add('hidden');
            initialMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            resultText.innerHTML = '';
            sourcesList.innerHTML = '';
            document.getElementById('sources-section').classList.add('hidden');
            pdfQueryTitle.classList.add('hidden');


            if (!query) {
                errorText.textContent = "تکایە پرسیارا گەڕینێ بنڤیسە.";
                errorMessage.classList.remove('hidden');
                return;
            }

            // Set loading state
            loadingIndicator.classList.remove('hidden');
            searchButton.disabled = true;
            buttonText.textContent = 'چاڤەرێ بە.....'; 
            searchIcon.classList.add('hidden');
            downloadButton.disabled = true;

            try {
                // The API result is now returned as a simplified object from our serverless function
                const serverResult = await fetchTextContent(query);

                if (!serverResult.text) {
                    throw new Error(serverResult.error || "دەستنڤیسا دروست نەهاتە ڤەگەراندن ژ لایێ سێرڤەری ڤە.");
                }

                const text = serverResult.text;
                const sources = serverResult.sources || [];
                
                // Formatting text for display
                let formattedText = text.split('\n').map(p => p.trim()).filter(p => p.length > 0).map(p => {
                    if (p.startsWith('* ') || p.startsWith('- ')) {
                        return `<li class="mr-4">${p.substring(2)}</li>`;
                    }
                    return `<p class="mb-3">${p}</p>`;
                }).join('');

                if (formattedText.includes('<li>')) {
                    formattedText = '<ul>' + formattedText.replace(/<\/p><p class="mb-3">/g, '').replace(/<p class="mb-3">/g, '').replace(/<\/p>/g, '') + '</ul>';
                }
                
                resultText.innerHTML = formattedText;
                
                // Set the query title for the PDF
                pdfQueryTitle.textContent = `پرسیار: ${query}`;
                pdfQueryTitle.classList.remove('hidden');

                // Display sources
                if (sources.length > 0) {
                    sources.forEach((source, index) => {
                        const sourceElement = document.createElement('a');
                        sourceElement.href = source.uri;
                        sourceElement.target = "_blank";
                        sourceElement.className = "block text-primary-dark hover:text-primary transition-colors hover:underline truncate hover:z-10 dark:text-primary-dark/80 dark:hover:text-primary-dark/90";
                        sourceElement.title = source.title;
                        sourceElement.innerHTML = `<span class="font-mono text-sm p-1 rounded-md bg-gray-200 dark:bg-gray-700 ml-2 shadow-sm">${index + 1}</span> ${source.title}`;
                        sourcesList.appendChild(sourceElement);
                    });
                    document.getElementById('sources-section').classList.remove('hidden');
                } else {
                    document.getElementById('sources-section').classList.add('hidden');
                }

                searchResultCard.classList.remove('hidden');
                downloadButton.disabled = false;

            } catch (error) {
                console.error("Search Error:", error);
                
                const userFriendlyError = error.message.includes('403') 
                    ? "گەهیشتن رەتکرن (403). ئەگەری هەیە سێرڤەر توشی کێشە بێت یان کلیلی API لایێ پشتەوە کارا نەکر بیت."
                    : error.message;

                errorText.textContent = userFriendlyError;
                errorMessage.classList.remove('hidden');
            } finally {
                // Reset to default state
                loadingIndicator.classList.add('hidden');
                searchButton.disabled = false;
                buttonText.textContent = 'گەریان';
                searchIcon.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>


